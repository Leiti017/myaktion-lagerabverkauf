<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MyAktion ¬∑ Lagerabverkauf Preis-Scanner</title>
  <meta name="theme-color" content="#1f4aa5">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(255,255,255,.25) 0%, transparent 60%),
        linear-gradient(135deg,#0b3b93,#1f4aa5 55%,#0b1220);
      color:#fff;
    }
    .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(12px)}
    .btn{padding:.85rem 1.05rem;border-radius:999px;font-weight:800;display:inline-flex;align-items:center;justify-content:center;gap:.55rem}
    .btn-primary{background:#fff;color:#0b1220;box-shadow:0 12px 30px rgba(0,0,0,.22)}
    .btn-ghost{color:#fff;border:1px solid rgba(255,255,255,.35);background:transparent}
    .card{border-radius:1.5rem}
    .money{font-variant-numeric: tabular-nums;}
  </style>
</head>

<link rel="icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">

<body>
<div class="max-w-3xl mx-auto px-4 py-6">
  <header class="flex items-center gap-3 mb-5">
    <div class="w-12 h-12 rounded-2xl bg-white/95 flex items-center justify-center overflow-hidden shadow-lg">
      <img src="/static/myaktion_logo.jpg" alt="MyAktion" class="max-w-[44px] max-h-[44px]"
           onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=&quot;text-slate-900 font-black&quot;>MA</span>'">
    </div>
    <div>
      <div class="text-2xl font-extrabold tracking-tight">MyAktion</div>
      <div class="text-sm opacity-85">Lagerabverkauf ¬∑ Preis-Scanner</div>
    </div>
  </header>

  <main class="glass card p-4 md:p-6 shadow-2xl">
    <div class="grid md:grid-cols-2 gap-4">
      <!-- Foto -->
      <section>
        <div class="text-sm font-semibold mb-2">Foto</div>

        <input id="file" type="file" accept="image/*" capture="environment" class="hidden">

        <button id="btn" class="btn btn-primary w-full">
          üì∏ Foto aufnehmen
        </button>

        <div id="preview" class="mt-3 rounded-2xl overflow-hidden border border-white/15 bg-black/20 min-h-[220px] flex items-center justify-center">
          <div class="text-sm opacity-75 text-center px-6">Mach ein Foto vom Produkt (Vorderseite/Etikett).<br>Danach werden die Preise berechnet.</div>
        </div>

        <div class="mt-3 flex gap-2">
          <button id="btn-again" class="btn btn-ghost w-full" disabled>‚ôªÔ∏è Neues Foto</button>
        </div>

        <div id="status" class="text-xs opacity-80 mt-2">Bereit.</div>
      </section>

      <!-- Ergebnis -->
      <section>
        <div class="text-sm font-semibold mb-2">Ergebnis</div>

        <div class="glass card p-4">
          <div class="text-xs opacity-80">Listenpreis (Neupreis)</div>
          <div id="lp" class="money text-3xl font-extrabold mt-1">‚Äì</div>

          <div class="h-px bg-white/10 my-4"></div>

          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-xs opacity-80">Unser Preis</div>
              <div id="op" class="money text-4xl font-extrabold mt-1">‚Äì</div>
            </div>
            <div class="text-right">
              <div class="text-xs opacity-80">Rabatt</div>
              <div class="text-xl font-extrabold">-20%</div>
            </div>
          </div>

          <div id="note" class="text-[11px] opacity-75 mt-3"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="text-[11px] opacity-70 mt-4">
    Tipp: Wenn das Produkt nicht eindeutig erkennbar ist, wird ggf. 0,00 ‚Ç¨ ausgegeben ‚Äì dann bitte ein besseres Foto machen.
  </footer>
</div>

<script>
  const file = document.getElementById('file');
  const btn = document.getElementById('btn');
  const btnAgain = document.getElementById('btn-again');
  const preview = document.getElementById('preview');
  const statusEl = document.getElementById('status');
  const lpEl = document.getElementById('lp');
  const opEl = document.getElementById('op');
  const noteEl = document.getElementById('note');

  function money(n){
    const v = Number(n||0);
    return v.toFixed(2).replace(".", ",") + " ‚Ç¨";
  }

  function setBusy(on, text){
    statusEl.textContent = text || (on ? "Berechne ‚Ä¶" : "Bereit.");
    btn.disabled = on;
    btnAgain.disabled = on;
  }

  btn.onclick = () => file.click();
  btnAgain.onclick = () => {
    file.value = "";
    preview.innerHTML = '<div class="text-sm opacity-75 text-center px-6">Mach ein Foto vom Produkt (Vorderseite/Etikett).<br>Danach werden die Preise berechnet.</div>';
    lpEl.textContent = "‚Äì";
    opEl.textContent = "‚Äì";
    noteEl.textContent = "";
    statusEl.textContent = "Bereit.";
    btnAgain.disabled = true;
  };

  file.addEventListener('change', async ()=>{
    const f = file.files && file.files[0];
    if(!f) return;

    // Preview
    const reader = new FileReader();
    reader.onload = (ev)=> preview.innerHTML = `<img src="${ev.target.result}" class="w-full h-full object-contain bg-black/20">`;
    reader.readAsDataURL(f);

    btnAgain.disabled = false;
    setBusy(true, "Berechne Preise ‚Ä¶");

    const fd = new FormData();
    fd.append('file', f);

    try{
      const res = await fetch('/api/scan', { method:'POST', body: fd });
      const j = await res.json();

      if(!res.ok || !j.ok){
        setBusy(false, "Fehler: " + (j.error || res.status));
        noteEl.textContent = "Bitte nochmal versuchen.";
        lpEl.textContent = "‚Äì";
        opEl.textContent = "‚Äì";
        return;
      }

      lpEl.textContent = money(j.list_price);
      opEl.textContent = money(j.our_price);
      noteEl.textContent = "Berechnet in " + (j.runtime_ms || 0) + " ms.";
      setBusy(false, "Fertig.");
    }catch(e){
      setBusy(false, "Fehler beim Upload.");
      noteEl.textContent = String(e||"");
    }
  });
</script>
</body>
</html>
