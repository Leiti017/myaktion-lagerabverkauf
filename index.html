<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>MyAktion Â· Lagerabverkauf</title>

  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#0F4E8C">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="MyAktion">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- Favicons -->
  <link rel="icon" href="/static/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

  <!-- iOS Splash (optimiert) -->
  <link rel="apple-touch-startup-image" href="/static/apple-splash-1170-2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="/static/apple-splash-1284-2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="/static/apple-splash-2048-2732.png" media="(min-device-width: 1024px) and (min-device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{
      min-height:100vh;
      background:radial-gradient(1200px 600px at 80% -10%, #e7f1ff 0%, transparent 60%),
                linear-gradient(135deg,#0F4E8C,#163B66 60%,#0b1220);
      color:#fff;
    }
    .glass{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(12px)}
    .btn{padding:.7rem 1.1rem;border-radius:999px;font-weight:800}
    .btn-primary{background:#fff;color:#0b1220}
    .btn-ghost{border:1px solid rgba(255,255,255,.35)}
    .card{border-radius:24px}
    .price{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="max-w-xl mx-auto px-4 py-6">
    <header class="flex items-center gap-3 mb-5">
      <div class="w-12 h-12 rounded-full bg-white flex items-center justify-center overflow-hidden">
        <img src="/static/myaktion_logo.jpg" alt="MyAktion" class="w-10 h-10 object-contain">
      </div>
      <div>
        <div class="text-2xl font-black tracking-tight">MyAktion</div>
        <div class="text-sm text-white/80">Lagerabverkauf Â· Foto â†’ Preis</div>
      </div>
    </header>

    <main class="glass card p-4 shadow-xl">
      <input id="file" type="file" accept="image/*" capture="environment" class="hidden">
      <button id="btn" class="btn btn-primary w-full text-lg">ðŸ“¸ Foto machen</button>

      <div id="previewWrap" class="mt-4 hidden">
        <img id="preview" class="w-full rounded-2xl border border-white/20" alt="Vorschau">
      </div>

      <div id="result" class="mt-4 hidden">
        <div class="glass card p-4">
          <div class="text-sm text-white/80 mb-2">Ergebnis</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="glass card p-3">
              <div class="text-xs text-white/70">Listenpreis</div>
              <div id="lp" class="text-2xl font-black price">â€”</div>
            </div>
            <div class="glass card p-3 border border-orange-300/40">
              <div class="text-xs text-white/70">Unser Preis (-20%)</div>
              <div id="up" class="text-2xl font-black price text-orange-200">â€”</div>
            </div>
          </div>
          <div id="hint" class="text-xs text-white/70 mt-3"></div>
        </div>
      </div>

      <div id="loading" class="mt-4 hidden text-sm text-white/80">Analysiereâ€¦</div>
    </main>

    <p class="text-xs text-white/70 mt-4">Tipp: Als App installierbar (PWA). Offline zeigt eine Info-Seite.</p>
  </div>

<script>
  // Register Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/sw.js").catch(()=>{});
    });
  }

  const btn = document.getElementById("btn");
  const file = document.getElementById("file");
  const previewWrap = document.getElementById("previewWrap");
  const preview = document.getElementById("preview");
  const result = document.getElementById("result");
  const loading = document.getElementById("loading");
  const lp = document.getElementById("lp");
  const up = document.getElementById("up");
  const hint = document.getElementById("hint");

  btn.addEventListener("click", () => file.click());

  file.addEventListener("change", async () => {
    const f = file.files && file.files[0];
    if (!f) return;

    // Preview
    const url = URL.createObjectURL(f);
    preview.src = url;
    previewWrap.classList.remove("hidden");
    result.classList.add("hidden");
    loading.classList.remove("hidden");
    hint.textContent = "";

    try {
      const fd = new FormData();
      fd.append("image", f);

      const r = await fetch("/api/scan", { method: "POST", body: fd });
      if (!r.ok) throw new Error("Scan fehlgeschlagen");
      const data = await r.json();

      const listen = Number(data.list_price || 0);
      const unser = Number(data.our_price || 0);

      const fmt = (n) => n.toLocaleString("de-AT", { style:"currency", currency:"EUR" });

      lp.textContent = listen ? fmt(listen) : "â€”";
      up.textContent = unser ? fmt(unser) : "â€”";
      hint.textContent = data.source ? ("Quelle: " + data.source) : "";

      result.classList.remove("hidden");
    } catch(e) {
      hint.textContent = "Fehler: " + (e.message || e);
      result.classList.remove("hidden");
    } finally {
      loading.classList.add("hidden");
    }
  });
</script>
</body>
</html>
